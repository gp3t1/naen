#!/bin/bash

function user_exists {
	if [[ $# -ne 1 ]] ; then
		return 1
	fi
	local user_name=$1
	gosu postgres psql -c "\du" | awk -F '|' '{ if (NR>3)  print $1 }' | grep -wq "$user_name"
}

function db_exists {
	if [[ $# -ne 1 ]] ; then 
		return 1
	fi
	local db_name=$1
	gosu postgres psql -lqt | awk -F '|' '{ print $1 }' | grep -wq "$db_name"
}


function main {
	if [[ $# -ne 2 ]] ; then 
		echo "usage : $0 <username> <password>" 
		exit 1
	fi

	USER=$1
	PASS=$2

	if ! user_exists "$USER"; then
		gosu postgres /usr/bin/psql -c "CREATE USER $USER WITH LOGIN PASSWORD '$PASS';" && echo "User     $USER created!"
	fi

	if ! db_exists "$USER"; then
		gosu postgres /usr/bin/psql -c "CREATE DATABASE $USER OWNER $USER;"							&& echo "Database $USER created!"
	fi

	gosu postgres /usr/bin/psql -c "GRANT ALL PRIVILEGES ON DATABASE $USER TO $USER;"

	db_exists "$USER"
}

echo "$0 $1"
main "$@"