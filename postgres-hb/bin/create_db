#!/bin/bash

function user_exists{
	[[ $# -ne 1 ]] && return 1
	local user_name=$1
	gosu postgres psql -c "\du" | awk -F '|' '{ if (NR>3)  print $1 }' | grep -wq "$user_name"
}

function db_exists {
	[[ $# -ne 1 ]] && return 1
	local db_name=$1
	gosu postgres psql -lqt | awk -F '|' '{ print $1 }' | grep -wq "$db_name"
}


function main {
	[[ $# -ne 2 ]] && echo "usage : $0 <username> <password>" && exit 1

	USER=$1
	PASS=$2

	if ! user_exists "$USER"; then
		gosu postgres /usr/bin/psql -c "CREATE USER $USER WITH LOGIN PASSWORD '$PASS';" && echo "User     $USER created!"
	fi

	if ! db_exists "$USER"; then
		gosu postgres /usr/bin/psql -c "CREATE DATABASE $USER OWNER $USER;"							&& echo "Database $USER created!"
	fi

	gosu postgres /usr/bin/psql -c "GRANT ALL PRIVILEGES ON DATABASE $USER TO $USER;"


	db_exists "$USER"
}

main "$@"